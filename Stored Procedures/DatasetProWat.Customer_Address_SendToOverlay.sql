SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO




/*=============================================
  Author:      RYFE
  Description: Populate customer address overlay table

  V1	07/07/2022	RYFE	Created
=============================================*/
CREATE PROCEDURE [DatasetProWat].[Customer_Address_SendToOverlay]
AS
BEGIN
SET NOCOUNT ON;

	DECLARE @MIG_SITENAME varchar(5) = 'GBASP';
	

	---------------- Delete records already in the loading table for this site -----------------------------------------------
	BEGIN TRANSACTION
		DELETE FROM [Dataset].[Customer_Address_ovl] 
		WHERE MIG_SITE_NAME = @MIG_SITENAME
		AND isSuspect = 1
		COMMIT TRANSACTION
	---------------- Add records to the loading table ---------------------------------------------------------
	
	SELECT * INTO #RECS from (  ---THIS CAN BE CHANGED TO SELECT * FROM TO BE ABLE TO REFERENCE THE CASE ALIAS (REMOVE INTO#TEMP)

SELECT
       [MIG_SITE_NAME]
      ,[CUSTOMER_ID]
      ,1 AS [IsSuspect]
      ,[NAME]
      ,[ADDRESS1]
      ,[ADDRESS2]
      ,[ZIP_CODE] AS [SRC_ZIP_CODE]
      ,[CITY]
      ,[COUNTY]
      ,[STATE]
      ,[NX_SUPPLY_COUNTRY_DB]
      ,[NX_DELIVERY_COUNTRY_DB]
      ,[VAT_NO]
      ,[SPECIAL_INS]
      ,[WORK_ORDER_NOTES]
      ,[NX_LONGITUDE]
      ,[NX_LATITUDE]
      ,[NX_ADDRESS_ID]
      ,[NX_DELIVERY_TERMS]
      ,[NX_SHIP_VIA_CODE]
      ,[NX_IN_CITY]
      ,[NX_TAX_WITHHOLDING_DB]
      ,[NX_TAX_ROUNDING_METHOD_DB]
      ,[NX_TAX_ROUNDING_LEVEL_DB]
      ,[NX_TAX_EXEMPT_DB]
      ,[NX_INTRASTAT_EXEMPT_DB]
      ,[NX_OPENING_AM]
      ,[NX_CLOSING_AM]
      ,[NX_OPENING_PM]
      ,[NX_CLOSING_PM]
      ,[NX_MON_AM]
      ,[NX_MON_PM]
      ,[NX_TUE_AM]
      ,[NX_TUE_PM]
      ,[NX_WED_AM]
      ,[NX_WED_PM]
      ,[NX_THU_AM]
      ,[NX_THU_PM]
      ,[NX_FRI_AM]
      ,[NX_FRI_PM]
      ,[NX_SAT_AM]
      ,[NX_SAT_PM]
      ,[NX_SUN_AM]
      ,[NX_SUN_PM]
      ,[NX_DEF_ADDRESS_DELIVERY]
      ,[NX_DEF_ADDRESS_INVOICE]
      ,[NX_DEF_ADDRESS_PAY]
      ,[NX_DEF_ADDRESS_HOME]
      ,[NX_DEF_ADDRESS_PRIMARY]
      ,[NX_DEF_ADDRESS_SECONDARY]
      ,[NX_DEF_ADDRESS_VISIT]
      ,[NX_TAX_REGIME_DB]
      ,[NX_COUNTRY_DB]
      ,[NX_COMPANY]
	  ,[ZIP_CODE]
	  ,CASE
       WHEN [ZIP_CODE] IS NULL
       THEN '1'

       WHEN [ZIP_CODE] LIKE '%.'
       THEN '2'
	   WHEN [ZIP_CODE] like '%  %'
	   THEN '6'

-- A9 9AA
      WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][0123456789] [0123456789][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
      THEN '0'
	  WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][0123456789] [O][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
	  THEN '4'
	  WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][0123456789]'
	  THEN '5'

-- A99 9AA
      WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][0123456789][0123456789] [0123456789][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
      THEN '0'
      WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][0123456789][0123456789] [O][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
      THEN '4'
	  WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][0123456789][0123456789]'
	  THEN '5'

-- AA9 9AA
      WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][ABCDEFGHKLMNOPQRSTUVWXY][0123456789] [0123456789][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
      THEN '0'
      WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][ABCDEFGHKLMNOPQRSTUVWXY][0123456789] [O][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
	  THEN '4'
	  WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][ABCDEFGHKLMNOPQRSTUVWXY][0123456789]'
	  THEN '5'

-- AA99 9AA
      WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][ABCDEFGHKLMNOPQRSTUVWXY][0123456789][0123456789] [0123456789][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
      THEN '0'
      WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][ABCDEFGHKLMNOPQRSTUVWXY][0123456789][0123456789] [O][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
      THEN '4'
      WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][ABCDEFGHKLMNOPQRSTUVWXY][0123456789][0123456789]'
	  THEN '5'

-- A9A 9AA
      WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][0123456789][ABCDEFGHJKSTUW] [0123456789][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
      THEN '0'
	  WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][0123456789][ABCDEFGHJKSTUW] [O][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
	  THEN '4'
	  WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][0123456789][ABCDEFGHJKSTUW]'
	  THEN '5'

-- AA9A 9AA
	   WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][ABCDEFGHKLMNOPQRSTUVWXY][0123456789][ABCDEFGHKLMNOPQRSTUVWXY] [0123456789][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
	   THEN '0'
	   WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][ABCDEFGHKLMNOPQRSTUVWXY][0123456789][ABCDEFGHKLMNOPQRSTUVWXY] [O][ABDEFGHJLNPQRSTUWXYZ][ABDEFGHJLNPQRSTUWXYZ]'
	   THEN '4'
	   WHEN [ZIP_CODE] LIKE '[ABCDEFGHIJKLMNOPRSTUWYZ][ABCDEFGHKLMNOPQRSTUVWXY][0123456789][ABCDEFGHKLMNOPQRSTUVWXY]'
	   THEN '5'

WHEN [ZIP_CODE] LIKE '[A-Z][A-Z][0-9][0-9][A-Z][A-Z]'      THEN '3'--LEFT([ZIP_CODE],3)+' '+RIGHT([ZIP_CODE],3)
WHEN [ZIP_CODE] LIKE '[A-Z][0-9][0-9][A-Z][A-Z]'           THEN '3'--LEFT([ZIP_CODE],2)+' '+RIGHT([ZIP_CODE],3)
WHEN [ZIP_CODE] LIKE '[A-Z][0-9][0-9][0-9][A-Z][A-Z]'      THEN '3'--LEFT([ZIP_CODE],3)+' '+RIGHT([ZIP_CODE],3)
WHEN [ZIP_CODE] LIKE '[A-Z][0-9][A-Z][0-9][A-Z][A-Z]'      THEN '3'--LEFT([ZIP_CODE],3)+' '+RIGHT([ZIP_CODE],3)
WHEN [ZIP_CODE] LIKE '[A-Z][A-Z][0-9][0-9][0-9][A-Z][A-Z]' THEN '3'--LEFT([ZIP_CODE],4)+' '+RIGHT([ZIP_CODE],3)
WHEN [ZIP_CODE] LIKE '[A-Z][A-Z][0-9][A-Z][0-9][A-Z][A-Z]' THEN '3'--LEFT([ZIP_CODE],4)+' '+RIGHT([ZIP_CODE],3)
	   
   ELSE '1'
   END AS [ZIP_CODE_VALIDATE]
     
  FROM [GBASP_Angel_DataCleansing_DataSet].[DatasetProWat].[Customer_Address_ex_Filtered]
  where mig_site_name = 'GBASP'
  ) s
 where s.zip_code_validate IN ('3','4','6')			--Only these can be updated as below and overlayed
  ORDER BY s.[ZIP_CODE]

  

  UPDATE #RECS
  SET ZIP_CODE = LEFT([ZIP_CODE],3)+' '+RIGHT([ZIP_CODE],3) WHERE [ZIP_CODE] LIKE '[A-Z][A-Z][0-9][0-9][A-Z][A-Z]'

  UPDATE #RECS
  SET ZIP_CODE = LEFT([ZIP_CODE],2)+' '+RIGHT([ZIP_CODE],3) WHERE [ZIP_CODE] LIKE '[A-Z][0-9][0-9][A-Z][A-Z]' 

  UPDATE #RECS
  SET ZIP_CODE = LEFT([ZIP_CODE],3)+' '+RIGHT([ZIP_CODE],3) WHERE [ZIP_CODE] LIKE '[A-Z][0-9][0-9][0-9][A-Z][A-Z]'

  UPDATE #RECS
  SET ZIP_CODE = LEFT([ZIP_CODE],3)+' '+RIGHT([ZIP_CODE],3) WHERE [ZIP_CODE] LIKE '[A-Z][0-9][A-Z][0-9][A-Z][A-Z]' 

  UPDATE #RECS
  SET ZIP_CODE = LEFT([ZIP_CODE],4)+' '+RIGHT([ZIP_CODE],3) WHERE  [ZIP_CODE] LIKE '[A-Z][A-Z][0-9][0-9][0-9][A-Z][A-Z]'

  UPDATE #RECS
  SET ZIP_CODE = LEFT([ZIP_CODE],4)+' '+RIGHT([ZIP_CODE],3) WHERE [ZIP_CODE] LIKE '[A-Z][A-Z][0-9][A-Z][0-9][A-Z][A-Z]'

 -- UPDATE #TEMP
 --SET ZIP_CODE =  REPLACE(ZIP_CODE,'.','')
 --WHERE ZIP_CODE_VALIDATE = '2';             --REMOVE FULL STOP. DON'T NEED THIS PART AS YOU WILL CATER FOR IT USING THE NON ALPHANUMERIC LOGIC

 UPDATE #RECS
 SET ZIP_CODE = Replace(ZIP_CODE,'  ',' ')
 WHERE ZIP_CODE_VALIDATE = '6'  --REMOVE DOUBLE SPACE



 UPDATE #RECS
 SET ZIP_CODE = REPLACE(zip_code,left(SUBSTRING([ZIP_CODE], CHARINDEX(' ', [ZIP_CODE]) + 1, LEN([ZIP_CODE])),1),'0')
 WHERE ZIP_CODE_VALIDATE = '4'
	

 INSERT INTO [Dataset].[Customer_Address_ovl]
   (
      [MIG_SITE_NAME]
      ,[CUSTOMER_ID]
      ,[IsSuspect]
      ,[SRC_NAME]
      ,[SRC_ADDRESS1]
      ,[SRC_ADDRESS2]
      ,[SRC_ZIP_CODE]
      ,[SRC_CITY]
      ,[SRC_COUNTY]
      ,[SRC_STATE]
      ,[SRC_SUPPLY_COUNTRY_DB]
      ,[SRC_DELIVERY_COUNTRY_DB]
      ,[SRC_VAT_NO]
      ,[SRC_SPECIAL_INS]
      ,[SRC_WORK_ORDER_NOTES]
      ,[SRC_LONGITUDE]
      ,[SRC_LATITUDE]
      ,[SRC_ADDRESS_ID]
      ,[SRC_DELIVERY_TERMS]
      ,[SRC_SHIP_VIA_CODE]
      ,[SRC_IN_CITY]
      ,[SRC_TAX_WITHHOLDING_DB]
      ,[SRC_TAX_ROUNDING_METHOD_DB]
      ,[SRC_TAX_ROUNDING_LEVEL_DB]
      ,[SRC_TAX_EXEMPT_DB]
      ,[SRC_INTRASTAT_EXEMPT_DB]
      ,[SRC_OPENING_AM]
      ,[SRC_CLOSING_AM]
      ,[SRC_OPENING_PM]
      ,[SRC_CLOSING_PM]
      ,[SRC_MON_AM]
      ,[SRC_MON_PM]
      ,[SRC_TUE_AM]
      ,[SRC_TUE_PM]
      ,[SRC_WED_AM]
      ,[SRC_WED_PM]
      ,[SRC_THU_AM]
      ,[SRC_THU_PM]
      ,[SRC_FRI_AM]
      ,[SRC_FRI_PM]
      ,[SRC_SAT_AM]
      ,[SRC_SAT_PM]
      ,[SRC_SUN_AM]
      ,[SRC_SUN_PM]
      ,[SRC_DEF_ADDRESS_DELIVERY]
      ,[SRC_DEF_ADDRESS_INVOICE]
      ,[SRC_DEF_ADDRESS_PAY]
      ,[SRC_DEF_ADDRESS_HOME]
      ,[SRC_DEF_ADDRESS_PRIMARY]
      ,[SRC_DEF_ADDRESS_SECONDARY]
      ,[SRC_DEF_ADDRESS_VISIT]
      ,[SRC_TAX_REGIME_DB]
      ,[SRC_COUNTRY_DB]
      ,[SRC_COMPANY]
	  ,[ZIP_CODE]
   )
   SELECT
    [MIG_SITE_NAME]
      ,[CUSTOMER_ID]
      ,[IsSuspect]
      ,[NAME]
      ,[ADDRESS1]
      ,[ADDRESS2]
      ,[SRC_ZIP_CODE]
      ,[CITY]
      ,[COUNTY]
      ,[STATE]
      ,[NX_SUPPLY_COUNTRY_DB]
      ,[NX_DELIVERY_COUNTRY_DB]
      ,[VAT_NO]
      ,[SPECIAL_INS]
      ,[WORK_ORDER_NOTES]
      ,[NX_LONGITUDE]
      ,[NX_LATITUDE]
      ,[NX_ADDRESS_ID]
      ,[NX_DELIVERY_TERMS]
      ,[NX_SHIP_VIA_CODE]
      ,[NX_IN_CITY]
      ,[NX_TAX_WITHHOLDING_DB]
      ,[NX_TAX_ROUNDING_METHOD_DB]
      ,[NX_TAX_ROUNDING_LEVEL_DB]
      ,[NX_TAX_EXEMPT_DB]
      ,[NX_INTRASTAT_EXEMPT_DB]
      ,[NX_OPENING_AM]
      ,[NX_CLOSING_AM]
      ,[NX_OPENING_PM]
      ,[NX_CLOSING_PM]
      ,[NX_MON_AM]
      ,[NX_MON_PM]
      ,[NX_TUE_AM]
      ,[NX_TUE_PM]
      ,[NX_WED_AM]
      ,[NX_WED_PM]
      ,[NX_THU_AM]
      ,[NX_THU_PM]
      ,[NX_FRI_AM]
      ,[NX_FRI_PM]
      ,[NX_SAT_AM]
      ,[NX_SAT_PM]
      ,[NX_SUN_AM]
      ,[NX_SUN_PM]
      ,[NX_DEF_ADDRESS_DELIVERY]
      ,[NX_DEF_ADDRESS_INVOICE]
      ,[NX_DEF_ADDRESS_PAY]
      ,[NX_DEF_ADDRESS_HOME]
      ,[NX_DEF_ADDRESS_PRIMARY]
      ,[NX_DEF_ADDRESS_SECONDARY]
      ,[NX_DEF_ADDRESS_VISIT]
      ,[NX_TAX_REGIME_DB]
      ,[NX_COUNTRY_DB]
      ,[NX_COMPANY]
	  ,[ZIP_CODE]
	FROM #RECS

	
END


GO
